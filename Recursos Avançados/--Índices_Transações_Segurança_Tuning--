: Recursos Avan√ßados (Script Final)
1. √çndices (Otimiza√ß√£o de Busca)
Objetivo: Acelerar buscas frequentes que hoje seriam lentas (Full Table Scan).
-- 1.1. √çndice Simples
-- Cen√°rio: A busca por alunos pelo nome √© a opera√ß√£o mais comum na secretaria.
-- Tabela: usuario | Coluna: nome
CREATE INDEX idx_usuario_nome ON usuario(nome);
-- 1.2. √çndice Composto
-- Cen√°rio: Professores filtram notas frequentemente por prova e aluno espec√≠fico.
-- Tabela: nota_prova | Colunas: id_prova, id_aluno
CREATE INDEX idx_nota_prova_busca ON nota_prova(id_prova, id_aluno);
-- 1.3. √çndice √önico
-- Cen√°rio: O sistema precisa garantir que n√£o existam dois usu√°rios com o mesmo e-mail
(regra de neg√≥cio e login), al√©m de acelerar a busca no login.
-- Tabela: usuario | Coluna: email
CREATE UNIQUE INDEX idx_usuario_email ON usuario(email);
üí° Para o Relat√≥rio (Print do EXPLAIN):
Rode isto antes e depois de criar o √≠ndice idx_usuario_nome e tire print da diferen√ßa no
campo "type" ou "rows":
EXPLAIN SELECT * FROM usuario WHERE nome = 'Joao Silva';
2. Transa√ß√µes (ACID)
Objetivo: Garantir integridade dos dados em opera√ß√µes complexas.
Cen√°rio A: Sucesso (COMMIT)
Situa√ß√£o: Um aluno entregou um trabalho e o sistema deve registrar a entrega e j√° lan√ßar
uma nota provis√≥ria (0.0) para ser alterada depois. As duas coisas devem acontecer ou
nenhuma.
START TRANSACTION;
-- 1. Inserir o trabalho (caso fosse din√¢mico) ou registrar a entrega (simula√ß√£o)
-- Vamos supor atualiza√ß√£o da data de entrega em um cen√°rio real, mas aqui faremos Insert
de Nota
INSERT INTO nota_trabalho (id_nota_trabalho, id_trabalho, id_aluno, nota)
VALUES (100, 1, 1, 0.0); -- ID 100 fict√≠cio, ajuste conforme seu banco
-- 2. Atualizar status do aluno na turma (exemplo fict√≠cio de l√≥gica de neg√≥cio)
UPDATE aluno_turma SET situacao = 'matriculado' WHERE id_aluno = 1;
COMMIT;
-- O sistema confirma que ambas as opera√ß√µes foram salvas.
Cen√°rio B: Falha Controlada (ROLLBACK)
Situa√ß√£o: Tentar lan√ßar uma nota para um aluno que n√£o existe (erro de integridade),
desfazendo qualquer opera√ß√£o anterior.
START TRANSACTION;
-- 1. Tenta atualizar algo v√°lido
UPDATE disciplina SET carga_horaria = 80 WHERE id_disciplina = 1;
-- 2. Tenta inserir nota para aluno ID 9999 (que n√£o existe)
INSERT INTO nota_prova (id_nota_prova, id_prova, id_aluno, nota)
VALUES (200, 1, 9999, 10.0);
-- Como vai dar erro de chave estrangeira (FK), voc√™ executa:
ROLLBACK;
-- Verifique que a carga hor√°ria da disciplina VOLTOU ao valor original.
Demonstra√ß√£o de Isolamento (LOCK)
Abra duas abas/janelas do seu gerenciador de banco de dados (Sess√£o 1 e Sess√£o 2).
* Sess√£o 1:
START TRANSACTION;
UPDATE turma SET nome_turma = 'Turma Bloqueada' WHERE id_turma = 1;
-- N√ÉO d√™ commit ainda!
* Sess√£o 2:
SELECT * FROM turma WHERE id_turma = 1;
-- O select vai travar (ficar carregando) at√© a Sess√£o 1 dar COMMIT ou ROLLBACK.
Isso prova que o banco est√° protegendo o dado durante a edi√ß√£o.
3. Seguran√ßa (Controle de Acesso)
Objetivo: Princ√≠pio do menor privil√©gio.
-- 3.1. Cria√ß√£o dos Usu√°rios
CREATE USER 'admin_ead'@'localhost' IDENTIFIED BY 'admin123';
CREATE USER 'professor_user'@'localhost' IDENTIFIED BY 'prof123';
CREATE USER 'auditor_user'@'localhost' IDENTIFIED BY 'audit123';
-- 3.2. Concess√£o de Privil√©gios (GRANT)
-- Admin: Pode tudo
GRANT ALL PRIVILEGES ON *.* TO 'admin_ead'@'localhost';
-- Professor: Pode ver tudo, mas s√≥ insere/altera notas e atividades
GRANT SELECT ON banco_ead.* TO 'professor_user'@'localhost'; -- Ajuste "banco_ead"
para o nome do seu banco
GRANT INSERT, UPDATE ON banco_ead.nota_prova TO 'professor_user'@'localhost';
GRANT INSERT, UPDATE ON banco_ead.nota_trabalho TO 'professor_user'@'localhost';
GRANT INSERT, UPDATE ON banco_ead.atividade TO 'professor_user'@'localhost';
-- Auditor: Apenas leitura (SELECT) em tudo para gerar relat√≥rios
GRANT SELECT ON banco_ead.* TO 'auditor_user'@'localhost';
-- 3.3. Revoga√ß√£o (REVOKE)
-- Auditor n√£o deve ver as senhas dos usu√°rios
REVOKE SELECT ON banco_ead.usuario FROM 'auditor_user'@'localhost';
FLUSH PRIVILEGES;
Demonstra√ß√£o de Bloqueio:
Logue como auditor_user e tente deletar um aluno:
DELETE FROM aluno WHERE id_aluno = 1;
-- Erro esperado: DELETE command denied to user 'auditor_user'. (Tire print disso!)
4. Desempenho e Tuning (Otimiza√ß√£o)
Objetivo: Pegar uma consulta ruim e deix√°-la r√°pida.
Consulta Lenta 1: O problema do OR e falta de JOIN
Cen√°rio: Buscar alunos que tiraram nota baixa em prova OU trabalho.
* Ruim (Sem Tuning):
SELECT nome FROM usuario WHERE id_usuario IN (
SELECT id_aluno FROM nota_prova WHERE nota < 6
) OR id_usuario IN (
SELECT id_aluno FROM nota_trabalho WHERE nota < 6
);
* Otimizada (Com JOIN e UNION - Mais eficiente para √≠ndices):
SELECT u.nome
FROM usuario u
JOIN nota_prova np ON u.id_usuario = np.id_aluno
WHERE np.nota < 6
UNION
SELECT u.nome
FROM usuario u
JOIN nota_trabalho nt ON u.id_usuario = nt.id_aluno
WHERE nt.nota < 6;
Consulta Lenta 2: O problema do LIKE no in√≠cio
Cen√°rio: Buscar disciplinas que contenham "Web" no nome.
* Ruim (Full Table Scan garantido):
SELECT * FROM disciplina WHERE nome_disciplina LIKE '%Web%';
Explica√ß√£o: O % no come√ßo impede o uso de √≠ndices B-Tree normais.
* Otimizada:
SELECT id_disciplina, nome_disciplina FROM disciplina WHERE nome_disciplina LIKE
'Web%';
Melhoria: Ao remover o % do in√≠cio (assumindo que a busca comece com a palavra), o
banco consegue usar √≠ndices. Se n√£o for poss√≠vel remover, a solu√ß√£o t√©cnica seria sugerir
um √çndice Full-Text (recurso avan√ßado).
