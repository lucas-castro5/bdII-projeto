CREATE OR REPLACE VIEW vw_alunos_ativos AS
SELECT 
    u.nome AS nome_aluno,
    a.matricula,
    a.status_aluno,
    t.nome_turma,
    at.ano_letivo
FROM aluno a
JOIN usuario u ON u.id_usuario = a.id_aluno
LEFT JOIN aluno_turma at ON at.id_aluno = a.id_aluno
LEFT JOIN turma t ON t.id_turma = at.id_turma
WHERE a.status_aluno = 'ativo';

select *
from vw_alunos_ativos


CREATE OR REPLACE VIEW vw_professor_resumo AS
SELECT 
    u.nome AS nome_professor,
    COUNT(DISTINCT d.id_disciplina) AS qtd_disciplinas,
    COUNT(DISTINCT at.id_aluno) AS qtd_alunos
FROM professor p
JOIN usuario u ON u.id_usuario = p.id_professor
JOIN professor_disciplina pd ON pd.id_professor = p.id_professor
JOIN disciplina d ON d.id_disciplina = pd.id_disciplina
JOIN turma t ON t.id_turma = d.id_turma
LEFT JOIN aluno_turma at ON at.id_turma = t.id_turma
GROUP BY u.nome;

select *
from vw_professor_resumo


CREATE OR REPLACE VIEW vw_medias_alunos AS
SELECT 
    u.nome AS aluno,
    d.nome_disciplina AS disciplina,
    AVG(n.valor_nota) AS media_final,
    CASE 
        WHEN AVG(n.valor_nota) < 6 THEN 'Abaixo da Média'
        ELSE 'OK'
    END AS situacao
FROM aluno a
JOIN usuario u ON u.id_usuario = a.id_aluno
JOIN aluno_turma at ON at.id_aluno = a.id_aluno
JOIN turma t ON t.id_turma = at.id_turma
JOIN disciplina d ON d.id_turma = t.id_turma
LEFT JOIN avaliacao av ON av.id_disciplina = d.id_disciplina
LEFT JOIN nota n ON n.id_avaliacao = av.id_avaliacao
GROUP BY u.nome, d.nome_disciplina;


select *
from vw_medias_alunos


CREATE TABLE tb_auditoria_notas (
    id SERIAL PRIMARY KEY,                   -- ID único
    tabela VARCHAR(50),                      -- Tabela alterada
    id_registro INT,                         -- ID do registro alterado
    operacao VARCHAR(20),                    -- Tipo de operação (UPDATE)
    valor_antigo DECIMAL(5,2),               -- Nota antes
    valor_novo DECIMAL(5,2),                 -- Nota depois
    data_hora TIMESTAMP DEFAULT CURRENT_TIMESTAMP  -- Quando ocorreu
);

CREATE OR REPLACE FUNCTION fn_auditar_notas()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO tb_auditoria_notas
        (tabela, id_registro, operacao, valor_antigo, valor_novo)
    VALUES
        (TG_TABLE_NAME, OLD.id_nota, 'UPDATE', OLD.valor_nota, NEW.valor_nota);

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_auditar_nota
AFTER UPDATE ON nota
FOR EACH ROW
EXECUTE FUNCTION fn_auditar_notas();


CREATE OR REPLACE FUNCTION fn_validar_nota()
RETURNS TRIGGER AS $$
DECLARE
    max_valor INT;
BEGIN
    SELECT peso INTO max_valor
    FROM avaliacao
    WHERE id_avaliacao = NEW.id_avaliacao;

    IF NEW.valor_nota < 0 OR NEW.valor_nota > max_valor THEN
        RAISE EXCEPTION 'Nota inválida: %. Deve estar entre 0 e %.',
            NEW.valor_nota, max_valor;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;


CREATE TRIGGER trg_validar_nota
BEFORE INSERT OR UPDATE ON nota
FOR EACH ROW
EXECUTE FUNCTION fn_validar_nota();



CREATE OR REPLACE FUNCTION fn_media_aluno(
    idAluno INT,
    idDisciplina INT
)
RETURNS DECIMAL(5,2) AS $$
DECLARE
    mediaFinal DECIMAL(5,2);
BEGIN
    SELECT AVG(n.valor_nota)
    INTO mediaFinal
    FROM nota n
    JOIN avaliacao av ON av.id_avaliacao = n.id_avaliacao
    WHERE n.id_aluno = idAluno
      AND av.id_disciplina = idDisciplina;

    RETURN COALESCE(mediaFinal, 0);
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION fn_relatorio_turma(idTurma INT)
RETURNS TABLE (
    total_alunos INT,
    aprovados INT,
    reprovados INT,
    percentual_aprovacao DECIMAL(5,2)
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        COUNT(*) AS total,
        COUNT(*) FILTER (WHERE situacao = 'aprovado'),
        COUNT(*) FILTER (WHERE situacao = 'reprovado'),
        CASE 
            WHEN COUNT(*) = 0 THEN 0
            ELSE (COUNT(*) FILTER (WHERE situacao = 'aprovado')::DECIMAL 
                / COUNT(*)::DECIMAL) * 100
        END
    FROM aluno_turma
    WHERE id_turma = idTurma;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION registrar_assistencia_aula(
    p_id_aluno INT,
    p_id_aula INT
)
RETURNS TEXT
AS $$
DECLARE
    v_nome_aluno VARCHAR(100);
    v_titulo_aula VARCHAR(150);
    v_disciplina VARCHAR(100);
BEGIN
    -- Verifica se aluno existe
    SELECT nome INTO v_nome_aluno
    FROM usuario u
    JOIN aluno a ON a.id_aluno = u.id_usuario
    WHERE a.id_aluno = p_id_aluno;

    IF v_nome_aluno IS NULL THEN
        RETURN 'Erro: aluno não encontrado.';
    END IF;

    -- Verifica se aula existe
    SELECT ag.titulo, d.nome_disciplina 
    INTO v_titulo_aula, v_disciplina
    FROM aula_gravada ag
    JOIN disciplina d ON d.id_disciplina = ag.id_disciplina
    WHERE ag.id_aula = p_id_aula;

    IF v_titulo_aula IS NULL THEN
        RETURN 'Erro: aula não encontrada.';
    END IF;

    -- Caso tudo OK, retorna confirmação
    RETURN FORMAT(
        'Aluno %s assistiu à aula "%s" da disciplina %s.',
        v_nome_aluno, v_titulo_aula, v_disciplina
    );
END;
$$ LANGUAGE plpgsql;
SELECT registrar_assistencia_aula(101, 22);
